var H5P=H5P||{};H5P.PasaPalabra=function($){function Pasapalabra(options,id){this.options=$.extend(!0,{},{title:"Pasapalabra",timeLimit:300,letters:[],showSolutionText:"Mostrar solución",tryAgainText:"Intentar otra vez",caseSensitive:!1,ignoreAccents:!0,allowPasapalabra:!0,showScore:!0,roscoColor:"#3498db",correctColor:"#2ecc71",wrongColor:"#e74c3c"},options),this.id=id,this.currentLetter=null,this.score=0,this.timeLeft=this.options.timeLimit,this.timerInterval=null,this.gameState={},this.letterElements={}}return Pasapalabra.prototype.attach=function($container){var self=this;this.$container=$container,$container.addClass("h5p-pasapalabra"),$container.empty(),this.initGameState(),this.createGameStructure(),this.setupInteractions(),this.startTimer(),this.selectNextAvailableLetter()},Pasapalabra.prototype.initGameState=function(){this.options.letters.forEach(function(letterObj){var letter=letterObj.letter.toUpperCase();this.gameState[letter]={answered:!1,correct:!1,passed:!1,attempts:0}}.bind(this))},Pasapalabra.prototype.createGameStructure=function(){var self=this;self.$container.append('<div class="pasapalabra-title">'+self.options.title+"</div>"),self.$timer=$('<div class="pasapalabra-timer">Tiempo: <span class="time">'+self.timeLeft+"</span>s</div>"),self.$container.append(self.$timer);var $gameContainer=$('<div class="pasapalabra-game-container"></div>'),$rosco=$('<div class="pasapalabra-rosco"></div>'),letterCount=self.options.letters.length,radius=180,centerOffset=200,startAngle=-90;self.options.letters.forEach((function(letterObj,index){var letter=letterObj.letter.toUpperCase(),angle,angleRad=(index*(360/letterCount)-90)*Math.PI/180,$letter=$('<div class="pasapalabra-letter" data-letter="'+letter+'">'+letter+"</div>"),x=180*Math.cos(angleRad),y=180*Math.sin(angleRad),$letter;($letter=$('<div class="pasapalabra-letter" data-letter="'+letter+'">'+letter+"</div>")).css({left:200+x+"px",top:200+y+"px",backgroundColor:self.options.roscoColor,transform:"translate(-50%, -50%)"}),$rosco.append($letter),self.letterElements[letter]=$letter})),$gameContainer.append($rosco);var $gameArea=$('<div class="pasapalabra-game-area"></div>');self.$definition=$('<div class="pasapalabra-definition"></div>'),$gameArea.append(self.$definition),self.$answerInput=$('<input type="text" class="pasapalabra-answer" placeholder="Escribe tu respuesta...">'),$gameArea.append(self.$answerInput);var $controls=$('<div class="pasapalabra-controls"></div>');self.$submitBtn=$('<button class="pasapalabra-submit">Responder</button>'),self.$passBtn=$('<button class="pasapalabra-pasapalabra">Pasapalabra</button>'),self.options.allowPasapalabra||self.$passBtn.hide(),$controls.append(self.$submitBtn),$controls.append(self.$passBtn),$gameArea.append($controls),self.$feedback=$('<div class="pasapalabra-feedback"></div>'),$gameArea.append(self.$feedback),self.options.showScore&&(self.$score=$('<div class="pasapalabra-score">Puntuación: <span>0</span></div>'),$gameArea.append(self.$score)),$gameContainer.append($gameArea),self.$container.append($gameContainer)},Pasapalabra.prototype.setupInteractions=function(){var self=this;self.$container.on("click",".pasapalabra-letter",(function(){var letter=$(this).data("letter");self.selectLetter(letter)})),self.$submitBtn.click((function(){self.checkAnswer()})),self.$answerInput.keypress((function(e){13===e.which&&self.checkAnswer()})),self.$passBtn.click((function(){self.passLetter()}))},Pasapalabra.prototype.selectLetter=function(letter){var self=this;self.currentLetter&&self.letterElements[self.currentLetter.letter].stop().css("opacity",1);var selectedLetter=self.options.letters.find((function(l){return l.letter.toUpperCase()===letter}));selectedLetter&&!self.gameState[letter].answered&&(self.currentLetter=selectedLetter,self.$definition.text(selectedLetter.definition),self.$answerInput.val("").focus(),self.$feedback.empty(),self.letterElements[letter].animate({opacity:.3},500,"linear",(function(){$(this).animate({opacity:1},500,"linear")})).data("interval",setInterval((function(){self.letterElements[letter].animate({opacity:.5},500,"linear",(function(){$(this).animate({opacity:1},500,"linear")}))}),1e3)))},Pasapalabra.prototype.checkAnswer=function(){var self=this;if(self.currentLetter){var userAnswer=self.$answerInput.val().trim(),correctAnswer=self.currentLetter.answer,letter=self.currentLetter.letter.toUpperCase();if(userAnswer){self.options.caseSensitive||(userAnswer=userAnswer.toLowerCase(),correctAnswer=correctAnswer.toLowerCase()),self.options.ignoreAccents&&(userAnswer=self.removeAccents(userAnswer),correctAnswer=self.removeAccents(correctAnswer));var isCorrect=userAnswer===correctAnswer,alternatives;if(!isCorrect&&self.currentLetter.alternatives)isCorrect=self.currentLetter.alternatives.split(",").map((function(alt){return alt.trim()})).some((function(alt){var normalizedAlt=alt;return self.options.caseSensitive||(normalizedAlt=normalizedAlt.toLowerCase()),self.options.ignoreAccents&&(normalizedAlt=self.removeAccents(normalizedAlt)),userAnswer===normalizedAlt}));self.gameState[letter].answered=!0,self.gameState[letter].correct=isCorrect,self.gameState[letter].attempts++,clearInterval(self.letterElements[letter].data("interval")),self.letterElements[letter].stop().css("opacity",1).css("background-color",isCorrect?self.options.correctColor:self.options.wrongColor),isCorrect?(self.$feedback.text("¡Correcto!"),self.score++,self.options.showScore&&self.$score.find("span").text(self.score)):self.$feedback.text("Incorrecto. La respuesta era: "+self.currentLetter.answer),setTimeout((function(){self.selectNextAvailableLetter()}),1500)}else self.$feedback.text("Por favor ingresa una respuesta")}},Pasapalabra.prototype.passLetter=function(){var self=this;if(this.currentLetter){var letter=this.currentLetter.letter.toUpperCase();this.gameState[letter].passed=!0,clearInterval(this.letterElements[letter].data("interval")),this.letterElements[letter].stop().css("opacity",1),this.selectNextAvailableLetter()}},Pasapalabra.prototype.selectNextAvailableLetter=function(){var self=this,currentIndex,nextIndex=(self.options.letters.findIndex((function(l){return l.letter.toUpperCase()===(self.currentLetter?self.currentLetter.letter.toUpperCase():"")}))+1)%self.options.letters.length,startIndex=nextIndex,found=!1;do{var letter=self.options.letters[nextIndex].letter.toUpperCase();if(!self.gameState[letter].answered&&!self.gameState[letter].passed){self.selectLetter(letter),found=!0;break}nextIndex=(nextIndex+1)%self.options.letters.length}while(nextIndex!==startIndex&&!found);found||self.endGame()},Pasapalabra.prototype.startTimer=function(){var self=this;self.timerInterval=setInterval((function(){self.timeLeft--,self.$timer.find(".time").text(self.timeLeft),self.timeLeft<=0&&(clearInterval(self.timerInterval),self.endGame())}),1e3)},Pasapalabra.prototype.endGame=function(){var self=this;if(clearInterval(this.timerInterval),this.currentLetter){var letter=this.currentLetter.letter.toUpperCase();clearInterval(this.letterElements[letter].data("interval"))}var totalLetters=this.options.letters.length,correctAnswers=Object.values(this.gameState).filter(state=>state.correct).length;this.$definition.html("<strong>Juego terminado</strong><br>Respuestas correctas: "+correctAnswers+"/"+totalLetters),this.$answerInput.hide(),this.$submitBtn.hide(),this.$passBtn.hide(),this.triggerXAPI("completed",{score:Math.round(correctAnswers/totalLetters*100),correctAnswers:correctAnswers,totalQuestions:totalLetters,timeSpent:this.options.timeLimit-this.timeLeft})},Pasapalabra.prototype.removeAccents=function(str){return str.normalize("NFD").replace(/[\u0300-\u036f]/g,"")},Pasapalabra.prototype.getCopyrights=function(){return{title:this.options.title||"Pasapalabra",author:this.options.author||"Ariel Hernández Friz",license:this.options.license||"MIT"}},Pasapalabra}(H5P.jQuery);